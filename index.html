<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>é‰±å±±ã‚²ãƒ¼ãƒ </title>
<style>
  :root{
    --bg:#0b0f14;
    --panel:#121824;
    --panel2:#0f1420;
    --text:#e9f1ff;
    --muted:#a6b0c0;
    --accent:#5ee7ff;
    --accent2:#7cffad;
    --danger:#ff5e7a;
    --gold:#ffd76a;
    --tile-gap:6px;
    --cell:56px; /* ã‚¹ãƒãƒ›ã§æŒ‡ãŒå±Šãå¤§ãã• */
    --radius:14px;
    --shadow:0 10px 30px rgba(0,0,0,.35), inset 0 0 0 1px rgba(255,255,255,.03);
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; background:radial-gradient(1200px 600px at 80% -10%, #152035 0%, #0b0f14 50%, #07090d 100%);
    color:var(--text); font-family: ui-rounded, "SF Pro Rounded", "Hiragino Maru Gothic ProN", "Noto Sans JP", system-ui, sans-serif;
    display:flex; flex-direction:column; gap:10px; align-items:center;
  }
  header{
    width:min(560px, 100%); padding:10px 14px; border-radius:18px;
    background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
    box-shadow:var(--shadow); display:flex; gap:10px; align-items:center; justify-content:space-between;
    position:sticky; top:0; z-index:5; backdrop-filter: blur(10px);
  }
  .stat{display:flex; gap:12px; align-items:center; flex-wrap:wrap}
  .chip{
    background:linear-gradient(180deg, #171f30, #0e1422);
    padding:8px 12px; border-radius:999px; box-shadow:var(--shadow); display:flex; align-items:center; gap:8px; font-weight:700;
  }
  .chip small{color:var(--muted); font-weight:600}
  .meter{color:var(--accent2)}
  .score{color:var(--gold)}
  .pick{color:var(--accent)}
  .buy-btn{
    background:linear-gradient(180deg, #1a2438, #121a2c); color:var(--text); border:none; padding:8px 12px; border-radius:999px;
    box-shadow:var(--shadow); font-weight:700; cursor:pointer;
  }
  .buy-btn:active{transform:translateY(1px)}
  main{
    width:min(560px, 100%); display:grid; grid-template-columns: 1fr; gap:10px; padding:0 10px 16px;
  }
  .grid-wrap{
    background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
    border-radius:18px; box-shadow:var(--shadow); padding:12px;
  }
  .grid{
    display:grid; grid-template-columns: repeat(6, var(--cell));
    grid-auto-rows: var(--cell);
    gap:var(--tile-gap); justify-content:center;
    touch-action: manipulation;
  }
  .cell{
    width:var(--cell); height:var(--cell); border-radius:12px; position:relative; overflow:hidden;
    background:#1b2232; box-shadow:inset 0 2px 8px rgba(0,0,0,.5), 0 6px 20px rgba(0,0,0,.25);
    user-select:none;
  }
  .tile{
    position:absolute; inset:0; border-radius:12px; background-size:cover; background-position:center;
    display:flex; align-items:center; justify-content:center; font-weight:900; color:#fff;
  }
  .dirt{ background-image:url('dirt.png'); background-color:#7a5234; }
  .stone{ background-image:url('stone.png'); background-color:#5a6572; }
  .cave{ background-image:url('cave.png'); background-color:#2a2f3a; }
  .empty{ background:none; }
  .overlay{
    position:absolute; inset:auto 6px 6px 6px; background:rgba(0,0,0,.45);
    color:var(--text); border-radius:10px; padding:2px 6px; font-size:12px; text-align:center;
  }
  .countdown{ color:var(--accent); font-weight:800 }
  .tap-hint{
    position:absolute; inset:0; display:flex; align-items:center; justify-content:center; color:#fff; text-shadow:0 2px 8px rgba(0,0,0,.6);
    font-size:12px; background:rgba(0,0,0,.18);
  }
  .shake{
    animation:shake .25s ease-in-out both;
  }
  @keyframes shake{
    0%{ transform: translate(0,0) rotate(0deg) }
    25%{ transform: translate(2px,-2px) rotate(-10deg) }
    50%{ transform: translate(-2px,1px) rotate(8deg) }
    75%{ transform: translate(1px,2px) rotate(-6deg) }
    100%{ transform: translate(0,0) rotate(0deg) }
  }
  .emojix{
    position:absolute; font-size:22px; pointer-events:none; filter: drop-shadow(0 4px 8px rgba(0,0,0,.6));
    animation:pop .35s ease-out forwards;
  }
  @keyframes pop{
    0%{ opacity:0; transform: translate(-50%,-30%) scale(.6) rotate(-20deg) }
    60%{ opacity:1; transform: translate(-40%,-70%) scale(1.05) rotate(8deg) }
    100%{ opacity:0; transform: translate(-30%,-100%) scale(.9) rotate(0deg) }
  }
  .controls, .upgrades{
    background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
    border-radius:18px; box-shadow:var(--shadow); padding:12px;
  }
  .ctrl-row, .upg-row{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
  .ctrl-row button, .upg-card button{
    background:linear-gradient(180deg, #1a2438, #121a2c); color:var(--text); border:none; padding:10px 12px; border-radius:12px;
    box-shadow:var(--shadow); font-weight:800; cursor:pointer; min-width:110px;
  }
  .ctrl-row button:active, .upg-card button:active{ transform:translateY(1px) }
  .upgrades h3{ margin:6px 2px 10px; font-size:16px; color:var(--muted) }
  .upg-grid{ display:grid; grid-template-columns: repeat(2, 1fr); gap:10px }
  .upg-card{
    background:linear-gradient(180deg, #151c2c, #0e1422); border-radius:14px; padding:10px; box-shadow:var(--shadow);
    display:flex; flex-direction:column; gap:6px;
  }
  .upg-title{ font-weight:900 }
  .upg-meta{ color:var(--muted); font-size:12px }
  .highlight{ color:var(--accent2) }
  .note{ color:var(--muted); font-size:12px; text-align:center; margin-top:6px }
  /* Fallback if images missing */
  .dirt::after, .stone::after, .cave::after{
    content:""; position:absolute; inset:0; background:linear-gradient(180deg, rgba(255,255,255,.14), rgba(0,0,0,.18));
    border-radius:12px;
  }
</style>
</head>
<body>
  <header>
    <div class="stat">
      <div class="chip"><span>ğŸ“</span><small>æ·±åº¦</small><span class="meter" id="depth">0m</span></div>
      <div class="chip"><span>ğŸ’°</span><small>ã‚¹ã‚³ã‚¢</small><span class="score" id="score">0</span></div>
      <div class="chip"><span>â›ï¸</span><small>ãƒ”ãƒƒã‚±ãƒ«</small><span class="pick" id="pickaxes">50/100</span></div>
    </div>
    <button class="buy-btn" id="buyPick">ãƒ”ãƒƒã‚±ãƒ«è³¼å…¥ +1 (150pt)</button>
  </header>

  <main>
    <section class="grid-wrap">
      <div id="grid" class="grid" aria-label="é‰±å±±ã‚°ãƒªãƒƒãƒ‰"></div>
      <p class="note">ä¸‹æ®µã‚’å…¨éƒ¨æ˜ã‚‹ã¨ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã—ã¦æ·±ãæ½œã‚‹ã€‚åœŸ=100pt(1â›ï¸)ãƒ»çŸ³=200pt(2â›ï¸)ã€‚</p>
    </section>

    <section class="controls">
      <div class="ctrl-row">
        <button id="reset">ãƒªã‚»ãƒƒãƒˆ</button>
        <button id="spawnCave">é‰±çªŸã‚’å¬å–š(ãƒ†ã‚¹ãƒˆ)</button>
      </div>
    </section>

    <section class="upgrades">
      <h3>ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰</h3>
      <div class="upg-grid">
        <div class="upg-card">
          <div class="upg-title">ãƒ”ãƒƒã‚±ãƒ«å›å¾©é€Ÿåº¦ã‚¢ãƒƒãƒ—</div>
          <div class="upg-meta">ç¾åœ¨: <span id="u_regen_level" class="highlight">Lv.0</span> / æ¬¡ã‚³ã‚¹ãƒˆ: <span id="u_regen_cost">500</span>pt</div>
          <button id="u_regen_btn">è³¼å…¥</button>
          <div class="upg-meta">ãƒ™ãƒ¼ã‚¹5ç§’â†’ãƒ¬ãƒ™ãƒ«ã”ã¨ã«-10%ã€æœ€å°1ç§’/å€‹</div>
        </div>
        <div class="upg-card">
          <div class="upg-title">ãƒ”ãƒƒã‚±ãƒ«æœ€å¤§å€‹æ•°ã‚¢ãƒƒãƒ—</div>
          <div class="upg-meta">ç¾åœ¨: <span id="u_max_level" class="highlight">Lv.0</span> (<span id="u_max_cap">100</span>) / æ¬¡ã‚³ã‚¹ãƒˆ: <span id="u_max_cost">800</span>pt</div>
          <button id="u_max_btn">è³¼å…¥</button>
          <div class="upg-meta">ãƒ¬ãƒ™ãƒ«æ¯ã«+20ï¼ˆä¸Šé™200ï¼‰</div>
        </div>
        <div class="upg-card">
          <div class="upg-title">ãƒã‚¤ãƒ³ãƒˆã‚¢ãƒƒãƒ—</div>
          <div class="upg-meta">ç¾åœ¨: <span id="u_mult_level" class="highlight">Lv.0</span> (Ã—<span id="u_mult_val">1.00</span>) / æ¬¡ã‚³ã‚¹ãƒˆ: <span id="u_mult_cost">1000</span>pt</div>
          <button id="u_mult_btn">è³¼å…¥</button>
          <div class="upg-meta">ãƒ¬ãƒ™ãƒ«æ¯ã«+10%</div>
        </div>
        <div class="upg-card">
          <div class="upg-title">é‰±çªŸæ¡å–å€‹æ•°ã‚¢ãƒƒãƒ—</div>
          <div class="upg-meta">ç¾åœ¨: <span id="u_cave_level" class="highlight">Lv.0</span> / æ¬¡ã‚³ã‚¹ãƒˆ: <span id="u_cave_cost">700</span>pt</div>
          <button id="u_cave_btn">è³¼å…¥</button>
          <div class="upg-meta">ãƒ¬ãƒ™ãƒ«æ¯ã«+2å€‹ æ¡å–</div>
        </div>
      </div>
    </section>
  </main>

<script>
(() => {
  // ------------------ åŸºæœ¬è¨­å®š ------------------
  const COLS = 6;
  const ROWS = 7; // è¡¨ç¤ºè¡Œæ•°
  const POINTS = { dirt:100, stone:200 };
  const COST_PER_PICK = 150; // ã‚¹ã‚³ã‚¢è³¼å…¥ã®1æœ¬ã‚ãŸã‚Šä¾¡æ ¼
  const BASE_REGEN_SEC = 5;  // ãƒ™ãƒ¼ã‚¹å›å¾©é–“éš”ï¼ˆç§’ï¼‰
  const MIN_REGEN_SEC = 1;
  const INIT_PICKS = 50;
  const INIT_MAX = 100;
  const MAX_CAP_HARD = 200;

  // é‰±çªŸã®æ¢ç´¢æ™‚é–“ï¼ˆç§’ï¼‰
  const CAVE_TIME = { small:30, medium:60, large:120 };
  // é‰±çªŸã®åŸºç¤æ¡å–å€‹æ•°
  const CAVE_BASE_HARVEST = { small:4, medium:8, large:16 };

  // é‰±çŸ³ã®å‡ºç¾ç‡ï¼ˆæ–°è¡Œç”Ÿæˆæ™‚ï¼‰
  const SPAWN = {
    dirt: 0.6,
    stone: 0.35,
    cave: 0.05 // cave ã¯å¾Œã§å®Ÿã‚µã‚¤ã‚ºæŠ½é¸
  };

  // ------------------ çŠ¶æ…‹ ------------------
  const state = {
    grid: [],           // å¯è¦–é ˜åŸŸ7è¡ŒÃ—6åˆ—
    depth: 0,           // m
    score: 0,
    pick: INIT_PICKS,
    maxPick: INIT_MAX,
    regenLevel: 0,
    maxLevel: 0,
    multLevel: 0,
    caveLevel: 0,
    lastRegenTime: performance.now(),
    regenResidual: 0,   // ã‚µãƒ–ç§’ã®ç©ã¿ä¸Šã’
    caves: new Map(),   // caveId -> {size,status,remain, cells:[{r,c}], startedAt}
    nextCaveId: 1
  };

  // ------------------ DOM ------------------
  const gridEl = document.getElementById('grid');
  const depthEl = document.getElementById('depth');
  const scoreEl = document.getElementById('score');
  const picksEl = document.getElementById('pickaxes');
  const buyPickBtn = document.getElementById('buyPick');

  const uRegenLevel = document.getElementById('u_regen_level');
  const uRegenCost = document.getElementById('u_regen_cost');
  const uRegenBtn = document.getElementById('u_regen_btn');

  const uMaxLevel = document.getElementById('u_max_level');
  const uMaxCap = document.getElementById('u_max_cap');
  const uMaxCost = document.getElementById('u_max_cost');
  const uMaxBtn = document.getElementById('u_max_btn');

  const uMultLevel = document.getElementById('u_mult_level');
  const uMultVal = document.getElementById('u_mult_val');
  const uMultCost = document.getElementById('u_mult_cost');
  const uMultBtn = document.getElementById('u_mult_btn');

  const uCaveLevel = document.getElementById('u_cave_level');
  const uCaveCost = document.getElementById('u_cave_cost');
  const uCaveBtn = document.getElementById('u_cave_btn');

  const resetBtn = document.getElementById('reset');
  const spawnCaveBtn = document.getElementById('spawnCave');

  // ------------------ ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ ------------------
  const clamp = (v,min,max)=>Math.max(min,Math.min(max,v));
  const rand = (a,b)=>Math.floor(Math.random()*(b-a+1))+a;

  function pointsMult(){
    return 1 + state.multLevel * 0.10;
  }
  function regenIntervalMs(){
    const sec = Math.max(MIN_REGEN_SEC, BASE_REGEN_SEC * Math.pow(0.9, state.regenLevel));
    return sec * 1000;
  }
  function caveExtraHarvest(){
    return state.caveLevel * 2;
  }
  function upgradeCost(kind, level){
    // ã‚·ãƒ³ãƒ—ãƒ«ãªé€“å¢—
    switch(kind){
      case 'regen': return Math.floor(500 * Math.pow(1.6, level));
      case 'max':   return Math.floor(800 * Math.pow(1.55, level));
      case 'mult':  return Math.floor(1000* Math.pow(1.75, level));
      case 'cave':  return Math.floor(700 * Math.pow(1.6, level));
    }
  }

  // ------------------ ã‚°ãƒªãƒƒãƒ‰ç”Ÿæˆ ------------------
  function makeEmptyCell(){
    return { type:'empty', hp:0, caveId:null };
  }
  function makeBlock(type){
    if(type==='dirt') return { type:'dirt', hp:1, caveId:null };
    if(type==='stone') return { type:'stone', hp:2, caveId:null };
    return makeEmptyCell();
  }

  // è¡Œç”Ÿæˆï¼šæ´çªŸã¯ç¢ºç‡çš„ã«ã‚µã‚¤ã‚ºã‚’é¸ã³ã€ç½®ã‘ã‚Œã°ç½®ã
  function generateRow(){
    // ã¾ãšå…¨ã‚»ãƒ«ã‚’ dirt/stoneã§åˆæœŸåŒ–
    const row = Array.from({length:COLS}, ()=>{
      const r = Math.random();
      if(r < SPAWN.dirt) return makeBlock('dirt');
      if(r < SPAWN.dirt + SPAWN.stone) return makeBlock('stone');
      return makeBlock(Math.random()<0.5 ? 'dirt':'stone'); // fallback
    });

    // æ´çªŸæŠ½é¸
    if(Math.random() < SPAWN.cave){
      const sizes = ['small','medium','large'];
      const sizeWeights = [0.6, 0.3, 0.1];
      let p = Math.random();
      let size = 'small';
      if(p > 0.6) size = (p > 0.9) ? 'large' : 'medium';
      // ã“ã®è¡Œå˜ä½“ã ã¨ medium/large ã¯ç¸¦ã«å¿…è¦ã€‚ä¸Šã®è¡Œã«ã¾ãŸãŒã‚‹ã®ã§ã€ç”Ÿæˆã¯ã‚­ãƒ¥ãƒ¼ã—ã¦å¾Œã§é…ç½®
      // ã“ã“ã§ã¯smallã®ã¿ç¢ºå®Ÿã«ç½®ãï¼ˆ1x1ï¼‰ã€‚medium/largeã¯å¾Œç¶šãƒ­ã‚¸ãƒƒã‚¯ã§ãŸã¾ã«ä½œã‚‹ã€‚
      if(size==='small'){
        const c = rand(0,COLS-1);
        row[c] = { type:'cave', size:'small', hp:Infinity, caveId: null, status:'idle' };
      }
    }
    return row;
  }

  // medium/large ã®æ´çªŸã‚’ç„¡ç†ãªãæ™‚ã€…é…ç½®ï¼ˆã‚°ãƒªãƒƒãƒ‰å…¨ä½“è¦‹ã¦ç©ºé–“ãŒã‚ã‚Œã°ç½®ãï¼‰
  function tryPlaceBiggerCave(){
    const sizes = [
      {name:'large', w:3,h:3, chance:0.05},
      {name:'medium',w:2,h:2, chance:0.10}
    ];
    for(const s of sizes){
      if(Math.random() < s.chance){
        // ç©ºãé ˜åŸŸæ¢ç´¢ï¼ˆstone/dirtä¸Šã§ã‚‚ç½®ãã€ç½®ã„ãŸé ˜åŸŸã¯æ´çªŸåŒ–ï¼‰
        const maxR = ROWS - s.h;
        const maxC = COLS - s.w;
        const r0 = rand(0,maxR);
        const c0 = rand(0,maxC);
        // é‡è¤‡æ´çªŸã¯é¿ã‘ãŸã„ã®ã§ã€æ—¢ã«caveãªã‚»ãƒ«ãŒæ··ã–ã£ã¦ã„ãŸã‚‰ã‚¹ã‚­ãƒƒãƒ—
        for(let rr=r0; rr<r0+s.h; rr++){
          for(let cc=c0; cc<c0+s.w; cc++){
            if(state.grid[rr][cc].type==='cave'){ return; }
          }
        }
        // è¨­ç½®
        const id = state.nextCaveId++;
        const cells = [];
        for(let rr=r0; rr<r0+s.h; rr++){
          for(let cc=c0; cc<c0+s.w; cc++){
            state.grid[rr][cc] = { type:'cave', size:s.name, hp:Infinity, caveId:id, status:'idle' };
            cells.push({r:rr,c:cc});
          }
        }
        state.caves.set(id, { id, size:s.name, status:'idle', remain:CAVE_TIME[s.name], cells, startedAt:null });
      }
    }
  }

  function initGrid(){
    state.grid = [];
    for(let r=0;r<ROWS;r++){
      state.grid.push(generateRow());
    }
    // ãŸã¾ã«å¤§ãã„æ´çªŸ
    tryPlaceBiggerCave();
    state.depth = 0;
  }

  // ------------------ ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚° ------------------
  function render(){
    depthEl.textContent = state.depth + 'm';
    scoreEl.textContent = Math.floor(state.score);
    picksEl.textContent = `${state.pick}/${state.maxPick}`;

    // ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰è¡¨ç¤º
    uRegenLevel.textContent = 'Lv.'+state.regenLevel;
    uRegenCost.textContent = upgradeCost('regen', state.regenLevel);
    uMaxLevel.textContent = 'Lv.'+state.maxLevel;
    uMaxCap.textContent = state.maxPick;
    uMaxCost.textContent = upgradeCost('max', state.maxLevel);
    uMultLevel.textContent = 'Lv.'+state.multLevel;
    uMultVal.textContent = pointsMult().toFixed(2);
    uMultCost.textContent = upgradeCost('mult', state.multLevel);
    uCaveLevel.textContent = 'Lv.'+state.caveLevel;
    uCaveCost.textContent = upgradeCost('cave', state.caveLevel);

    // ã‚°ãƒªãƒƒãƒ‰
    gridEl.innerHTML = '';
    for(let r=0;r<ROWS;r++){
      for(let c=0;c<COLS;c++){
        const cell = document.createElement('div');
        cell.className='cell';
        cell.dataset.r=r; cell.dataset.c=c;

        const t = state.grid[r][c];
        const tile = document.createElement('div');
        tile.classList.add('tile');
        tile.classList.add(t.type);
        if(t.type==='dirt') tile.title='åœŸ 100pt / 1â›ï¸';
        if(t.type==='stone') tile.title='çŸ³ 200pt / 2â›ï¸';

        // æ´çªŸã®è¦‹ãŸç›®ã¨ã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³
        if(t.type==='cave'){
          // åŒã˜caveIdã®ä¸­ã§å·¦ä¸Šã‚»ãƒ«ã ã‘ã«UIã‚’æŒãŸã›ã‚‹
          const cid = t.caveId ?? findCaveIdAt(r,c);
          if(cid){
            const cave = state.caves.get(cid);
            if(isTopLeftOfCave(cid, r, c)){
              const ov = document.createElement('div');
              ov.className='overlay';
              const sizeJ = cave.size==='small'?'å°':(cave.size==='medium'?'ä¸­':'å¤§');
              if(cave.status==='idle'){
                ov.innerHTML = `é‰±çªŸ(${sizeJ})`;
              }else if(cave.status==='running'){
                ov.innerHTML = `æ¢ç´¢ä¸­â€¦<br><span class="countdown">${formatTime(cave.remain)}</span>`;
              }else if(cave.status==='done'){
                ov.innerHTML = `æ¡å–å®Œäº†ï¼<br><span class="countdown">ã‚¿ãƒƒãƒ—ã§å›å</span>`;
              }
              tile.appendChild(ov);
            }
          }else{
            // small å˜ä½“ã¯cidãªã„ã“ã¨ãŒã‚ã‚‹ã®ã§ã€idleé¢¨ã®ãƒ’ãƒ³ãƒˆ
            const ov = document.createElement('div');
            ov.className='overlay';
            ov.innerHTML = `é‰±çªŸ(å°)`;
            tile.appendChild(ov);
          }
        }

        cell.appendChild(tile);
        gridEl.appendChild(cell);
      }
    }
  }

  function isTopLeftOfCave(caveId, r, c){
    const cave = state.caves.get(caveId);
    if(!cave) return false;
    let minR=999, minC=999;
    cave.cells.forEach(p=>{ minR=Math.min(minR,p.r); minC=Math.min(minC,p.c); });
    return r===minR && c===minC;
  }

  function findCaveIdAt(r,c){
    for(const [id,cave] of state.caves.entries()){
      if(cave.cells.some(p=>p.r===r && p.c===c)) return id;
    }
    return null;
  }

  function formatTime(sec){
    sec = Math.max(0, Math.ceil(sec));
    const m = Math.floor(sec/60), s=sec%60;
    return m>0 ? `${m}:${String(s).padStart(2,'0')}` : `0:${String(s).padStart(2,'0')}`;
  }

  // ------------------ è¡Œã‚¹ã‚¯ãƒ­ãƒ¼ãƒ« ------------------
function checkAndScroll(force=false){
  if(force){
    // ä¸€ç•ªä¸Šã‚’æ¨ã¦ã¦ã€ä¸‹ã‹ã‚‰æ–°è¡Œ
    state.grid.shift();
    state.grid.push(generateRow());
    tryPlaceBiggerCave();
    // æ´çªŸã‚»ãƒ«ã®åº§æ¨™æ›´æ–°
    for(const cave of state.caves.values()){
      cave.cells.forEach(p=>p.r = p.r-1);
    }
    // ç”»é¢å¤–ã«æ¶ˆãˆãŸæ´çªŸã‚’é™¤å»
    for(const [id,cave] of Array.from(state.caves.entries())){
      const stillVisible = cave.cells.some(p => p.r>=0 && p.r<ROWS);
      if(!stillVisible) state.caves.delete(id);
    }
    state.depth += 1;
    render();
  }
}


  // ------------------ æ˜ã‚‹å‡¦ç† ------------------
  function tryMine(r,c){
    const t = state.grid[r][c];
    if(t.type==='dirt' || t.type==='stone'){
      const cost = t.type==='dirt' ? 1 : 2;
      if(state.pick < cost) return flashCell(r,c,'â›ï¸ä¸è¶³');
      state.pick -= cost;
      animatePick(r,c);

      // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³æ„Ÿ
      const cellEl = getCellEl(r,c);
      if(cellEl) cellEl.classList.add('shake');
      setTimeout(()=>cellEl && cellEl.classList.remove('shake'), 260);

      t.hp -= cost; // ä¸€æ°—ã«å‰Šã‚‹ï¼ˆã‚³ã‚¹ãƒˆã§hp=0ä»¥ä¸‹ã«ï¼‰
      if(t.hp <= 0){
        // ã‚¹ã‚³ã‚¢åŠ ç®—ï¼ˆå€ç‡ï¼‰
        const gained = Math.floor( (POINTS[t.type] || 0) * pointsMult() );
        state.score += gained;
        state.grid[r][c] = makeEmptyCell();
      }
      render();
 if(r === ROWS-1) checkAndScroll(true);

    } else if(t.type==='cave'){
      handleCaveTap(r,c);
    }
  }

  function flashCell(r,c,msg){
    const el = getTileEl(r,c);
    if(!el) return;
    const hint = document.createElement('div');
    hint.className='tap-hint';
    hint.textContent = msg;
    el.appendChild(hint);
    setTimeout(()=>hint.remove(), 450);
  }

  function animatePick(r,c){
    const cell = getCellEl(r,c);
    if(!cell) return;
    const em = document.createElement('div');
    em.className='emojix';
    em.textContent='â›ï¸';
    em.style.left='50%';
    em.style.top='50%';
    cell.appendChild(em);
    setTimeout(()=>em.remove(), 360);
  }

  function getCellEl(r,c){
    return gridEl.querySelector(`.cell[data-r="${r}"][data-c="${c}"]`);
  }
  function getTileEl(r,c){
    const cell = getCellEl(r,c);
    return cell ? cell.querySelector('.tile') : null;
  }

  // ------------------ é‰±çªŸå‡¦ç† ------------------
  function handleCaveTap(r,c){
    const id = findCaveIdAt(r,c);
    let cave;
    if(id){
      cave = state.caves.get(id);
    }else{
      // smallå˜ç™ºï¼ˆ1x1ï¼‰ã‚’ãã®å ´ã§ç™»éŒ²
      const newId = state.nextCaveId++;
      cave = { id:newId, size:'small', status:'idle', remain:CAVE_TIME.small, cells:[{r,c}], startedAt:null };
      state.caves.set(newId, cave);
      state.grid[r][c].caveId = newId;
    }

    if(cave.status==='idle'){
      cave.status='running';
      cave.remain=CAVE_TIME[cave.size];
      cave.startedAt = performance.now();
    }else if(cave.status==='running'){
      // ãªã«ã‚‚ã—ãªã„ï¼ˆé€²è¡Œä¸­ï¼‰
    }else if(cave.status==='done'){
      // æ¡å–çµæœã‚’å›åã—ã¦æ´çªŸã‚’æ¶ˆã™
      harvestFromCave(cave);
      // æ´çªŸã‚»ãƒ«ã‚’ç©ºã«æˆ»ã™
      cave.cells.forEach(p => state.grid[p.r][p.c] = makeEmptyCell());
      state.caves.delete(cave.id);
      render();
      checkAndScroll();
    }
  }

  function harvestFromCave(cave){
    // ã„ã¾è¦‹ãˆã¦ã‚‹æ˜ã‚Œã‚‹ãƒ–ãƒ­ãƒƒã‚¯ã‹ã‚‰ãƒ©ãƒ³ãƒ€ãƒ ã«ã„ãã¤ã‹è‡ªå‹•æ¡å–ï¼ˆãƒã‚¤ãƒ³ãƒˆã®ã¿ç²å¾—ã€ãƒ”ãƒƒã‚±ãƒ«æ¶ˆè²»ãªã—ï¼‰
    const candidates = [];
    for(let r=0;r<ROWS;r++){
      for(let c=0;c<COLS;c++){
        const t = state.grid[r][c];
        if(t.type==='dirt' || t.type==='stone'){
          candidates.push({r,c,type:t.type});
        }
      }
    }
    const base = CAVE_BASE_HARVEST[cave.size] || 4;
    const total = base + caveExtraHarvest();
    let picks = Math.min(total, candidates.length);
    let gained = 0;

    // è¿‘ã„ã‚»ãƒ«ã‚’å„ªå…ˆï¼ˆæ´çªŸã®é‡å¿ƒã«è¿‘ã„é †ï¼‰
    const cx = cave.cells.reduce((a,p)=>a+p.c,0)/cave.cells.length;
    const cy = cave.cells.reduce((a,p)=>a+p.r,0)/cave.cells.length;
    candidates.sort((A,B)=>{
      const dA = (A.c-cx)**2 + (A.r-cy)**2;
      const dB = (B.c-cx)**2 + (B.r-cy)**2;
      return dA - dB;
    });

    for(let i=0;i<picks;i++){
      const it = candidates[i];
      const val = Math.floor( (POINTS[it.type]||0) * pointsMult() );
      gained += val;
      // æ¶ˆã™
      state.grid[it.r][it.c] = makeEmptyCell();
      // ã¡ã‚‡ã„æ¼”å‡º
      sparkAt(it.r,it.c);
    }
    state.score += gained;
  }

  function sparkAt(r,c){
    const el = getCellEl(r,c);
    if(!el) return;
    const em = document.createElement('div');
    em.className='emojix';
    em.textContent = 'ğŸ’¥';
    em.style.left='50%'; em.style.top='50%';
    el.appendChild(em);
    setTimeout(()=>em.remove(), 360);
  }

  function tickCaves(dt){
    for(const cave of state.caves.values()){
      if(cave.status==='running'){
        cave.remain -= dt/1000;
        if(cave.remain <= 0){
          cave.remain = 0; cave.status='done';
        }
      }
    }
  }

  // ------------------ ãƒ”ãƒƒã‚±ãƒ«å›å¾©/è³¼å…¥ ------------------
  function regenTick(dt){
    // ã‚µãƒ–ã‚¿ã‚¤ãƒ ç®¡ç†ã§æ±ºã¾ã£ãŸé–“éš”ã”ã¨ã«+1
    const interval = regenIntervalMs();
    state.regenResidual += dt;
    while(state.regenResidual >= interval){
      state.regenResidual -= interval;
      if(state.pick < state.maxPick){
        state.pick++;
      }else{
        // ã„ã£ã±ã„ãªã‚‰æ®‹ä½™ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¦ç„¡é§„å›ã—é˜²æ­¢
        state.regenResidual = 0;
        break;
      }
    }
  }

  function buyPick(){
    if(state.score >= COST_PER_PICK && state.pick < state.maxPick){
      state.score -= COST_PER_PICK;
      state.pick += 1;
      render();
    }
  }

  // ------------------ ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰è³¼å…¥ ------------------
  function tryBuyUpgrade(kind){
    const level = kind==='regen'? state.regenLevel :
                  kind==='max'  ? state.maxLevel   :
                  kind==='mult' ? state.multLevel  :
                  state.caveLevel;
    const cost = upgradeCost(kind, level);
    if(state.score < cost) return;

    state.score -= cost;
    if(kind==='regen'){
      state.regenLevel++;
      // å³æ™‚ä½“æ„Ÿã®ãŸã‚ã€æ®‹ä½™ã‚’ãƒªã‚»ãƒƒãƒˆï¼ˆæ–°é–“éš”ã«é¦´æŸ“ã¾ã›ã‚‹ï¼‰
      state.regenResidual = 0;
    }else if(kind==='max'){
      state.maxLevel++;
      state.maxPick = clamp(INIT_MAX + state.maxLevel*20, INIT_MAX, MAX_CAP_HARD);
      state.pick = Math.min(state.pick, state.maxPick);
    }else if(kind==='mult'){
      state.multLevel++;
    }else if(kind==='cave'){
      state.caveLevel++;
    }
    render();
  }

  // ------------------ å…¥åŠ› ------------------
  gridEl.addEventListener('click', (e)=>{
    const cell = e.target.closest('.cell');
    if(!cell) return;
    const r = +cell.dataset.r;
    const c = +cell.dataset.c;
    tryMine(r,c);
  });

  buyPickBtn.addEventListener('click', buyPick);
  resetBtn.addEventListener('click', ()=>{
    // ã™ã¹ã¦åˆæœŸåŒ–
    state.score = 0;
    state.pick = INIT_PICKS;
    state.maxPick = INIT_MAX;
    state.regenLevel = 0;
    state.maxLevel = 0;
    state.multLevel = 0;
    state.caveLevel = 0;
    state.caves.clear();
    state.nextCaveId = 1;
    state.regenResidual = 0;
    initGrid();
    render();
  });

  uRegenBtn.addEventListener('click', ()=>tryBuyUpgrade('regen'));
  uMaxBtn.addEventListener('click', ()=>tryBuyUpgrade('max'));
  uMultBtn.addEventListener('click', ()=>tryBuyUpgrade('mult'));
  uCaveBtn.addEventListener('click', ()=>tryBuyUpgrade('cave'));

  // ãƒ†ã‚¹ãƒˆç”¨ï¼šä»Šã®é ˜åŸŸã«ä¸­/å¤§ã‚’ãŸã¾ã«ç½®ã
  spawnCaveBtn.addEventListener('click', ()=>{
    tryPlaceBiggerCave();
    render();
  });

  // ------------------ ãƒ«ãƒ¼ãƒ— ------------------
  let lastTime = performance.now();
  function loop(now){
    const dt = now - lastTime;
    lastTime = now;

    regenTick(dt);
    tickCaves(dt);

    // 1ç§’ã«2å›ãã‚‰ã„æç”»ï¼ˆç„¡é§„æ›´æ–°ã‚’é¿ã‘ãŸã„ãŒã‚·ãƒ³ãƒ—ãƒ«ã«ï¼‰
    if(now % 300 < 16) render();

    requestAnimationFrame(loop);
  }

  // ------------------ ã‚¹ã‚¿ãƒ¼ãƒˆ ------------------
  initGrid();
  render();
  requestAnimationFrame(loop);
})();
</script>
</body>
</html>
